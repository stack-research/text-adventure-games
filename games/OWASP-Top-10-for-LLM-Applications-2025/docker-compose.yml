services:
  game:
    image: python:3.12-slim
    working_dir: /workspace
    volumes:
      - ./:/workspace
    command: python courses/engine.py
    environment:
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_MODEL: llama3.2:3b
      COURSE: ${COURSE:-LLM01-Prompt-Injection}
    depends_on:
      ollama-init:
        condition: service_completed_successfully
    stdin_open: true
    tty: true

  ollama:
    image: ollama/ollama:latest
    ports:
      - "22434:11434"
    volumes:
      - ollama_data:/root/.ollama

  ollama-init:
    image: curlimages/curl:8.12.1
    depends_on:
      - ollama
    restart: "no"
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "until curl -sf http://ollama:11434/api/tags >/dev/null; do sleep 2; done;
      curl -sS http://ollama:11434/api/pull -d '{\"model\":\"llama3.2:3b\"}'"

  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: course
      POSTGRES_PASSWORD: course
      POSTGRES_DB: course
    ports:
      - "56432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data

  api:
    image: mccutchen/go-httpbin:latest
    ports:
      - "59080:80"

  mail:
    image: axllent/mailpit:latest
    ports:
      - "52025:1025"
      - "59025:8025"

volumes:
  ollama_data:
  pg_data:
